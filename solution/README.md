# koywe-challenge

## Getting started with DB (PostgreSQL)

- The DB will be running in a Docker container.

### Running DB

- The DB container is configured using Docker Compose, so to start it just run:

```shell
$ docker-compose up # Docker compose V1
$ docker compose up # Docker compose V2
```

### Creating DB schema and required tables

- The SQL script for create the DB schema and the tables is defined in the file [db/scripts/quotes-db.sql](../db/scripts/quotes-db.sql).
- By using a shell script just run the next and the database will be initialized:

```shell
./init-db.sh
Docker is not running # In case the Docker's daemon is not running
The container "koywe-challenge-psql" not exists # In case the db container is not created yet
The container "koywe-challenge-psql" is not running # In case the db container exists but it is not running

```

### To visually see the tables data

- I use Jetbrains DataGrip IDE to connect to the Postgres container and see the data on the DB `quotes-db`.

## Prisma ORM

- To make DB operations such as list, update, create or delete Prisma ORM has been configured and connected
to db container.

### Connect Prisma ORM to DB

- In the dotenv file, you I need to set the next:

```dotenv
DB_URL="postgresql://admin:admin1234@localhost:5432/quotes_db?schema=quotes_db"
```

- To get DB definition into Prisma schema, just need to run:

```shell
$ yarn prisma:db:pull
```

- Then, types from Prisma to use our DB I need to generate the files by running:

```shell
$ yarn prisma:db:generate
```

- The generate files and types can be found at [src/prisma-orm/generated](src/prisma-orm/generated).

### Schemas/Tables considered

- ``quote`` - Where all the quotes will be stored according as this challenge demands.
- ``auth_sessions`` - Where all the JSON Web Tokens will be stored in order to re-use an still valid one
per username.

## Postman

- To test this REST API I prepared the required files for a Workspace in Postman and test it.
- Just create a new blank workspace and a new collection in it.
- Once it is created, just need to click on the top left button named **import** and select/drop all
the files that are tracked in the folder [postman](postman).

## Dotenv file

- Just copy the file `.env.example` into a new file named `.env`.
- Fill up all the required environmental variables.

```dotenv
CRYPTO_MKT_API_BASE_URL='EXTRACTED FROM THE MAIN README.MD FILE'
CRYPTO_MKT_API_VERSION='EXTRACTED FROM THE MAIN README.MD FILE'
CRYPTO_MKT_API_LAYER='EXTRACTED FROM THE MAIN README.MD FILE'
DB_URL="postgresql://admin:admin1234@localhost:5432/quotes_db?schema=quotes_db"

# node -e "console.log(crypto.randomBytes(32).toString('hex'))"
JWT_SECRET="FOLLOW UP THE COMMAND ABOVE TO CREATE A NEW SECRET STRING"
JWT_LIFETIME="900" # These are count of seconds !! The JWT will be valid only for 15 minutes

```

## REST API

### Before to go, let's double check

- The Postgres DB is running in the docker container and the DB was initialized by running ``./init-db.sh``
in the terminal.
- The Prisma Schema types were well generated by running ``yarn prisma:db:generate``.
- The required environmental variables were set in the ``.env`` file.
- [Optional] The Postman workspace to test the REST API was well created and prepared with the collection,
global and local environments.

### Running the API

- Just run ``yarn start:dev``, and the REST API will be exposed at [http://localhost:3000](http://localhost:3000).

### Authentication/Authorization

- The authorization of this REST API is handled by generating JWT tokens.
- In the app, a middleware will listen every HTTP request to check the **authorization** header to
handle a valid (HTTP 200, 201) or invalid (HTTP 401, 419) request.

### Endpoints defined

#### [POST] /auth/login

- **Request body**:
  - ```json5
    {
      "username": "test1234", // Could be any text
      "password": "12345" // Could be any text
    }
    ```
- This endpoint will generate a new JWT token for a username. This new token will be saved in the DB.
- If the same user is sent in the request body, the endpoint will find in the DB a not expired token
and will returned, if non expired token is found a new one will be created.

#### [POST] /quotes

- **Authorization header required** (`Bearer eyJ...`).
    - If JWT is not sent in the request header, a `401 Unauthorized` response will be returned.
    - If the JWT is expired, a `419 Session expired` response will be returned.
- **Request body**:
  - ```json5
    {
      "amount": 1000000,
      "from": "ARS",
      "to": "ETH"
    }
    ```
- This endpoint hit to the Crypo Market API (provided in the main README.md file) in order to ge the
price rate based on a source and a target currency.
- Once the price rate is received, a new quote will be stored in the DB by adding a UUID as row ID and
an expiry date (5 minutes of lifetime from current date time).
- **Request response**:
  - ```json5
    {
      "id": "04edd18c-29f8-41bc-a39b-5e4dc438bd34",
      "from": "ARS",
      "to": "ETH",
      "amount": 1000000,
      "rate": 4.24887261476258e-7,
      "convertedAmount": 0.424887261476258,
      "timestamp": "2025-03-12T07:37:09.373Z",
      "expiresAt": "2025-03-12T07:42:09.371Z"
    }
    ```
    
#### [GET] /quotes/:id

- **Authorization header required** (`Bearer eyJ...`).
    - If JWT is not sent in the request header, a `401 Unauthorized` response will be returned.
    - If the JWT is expired, a `419 Session expired` response will be returned.
- **Request path params**:
  - A UUID
- This endpoint will return a non expired quote based on a UUID passed as path param in the request.
- If the quote request by a UUID is expired, a `404 Not Found` error will be returned.
- **Request response**:
  - ```json5
    {
      "id": "8aeb2638-b9cc-4541-8715-640da59cbbe3",
      "from": "ARS",
      "to": "ETH",
      "amount": "1000000",
      "rate": "4.262027761996436e-7",
      "convertedAmount": "0.4262027761996436",
      "timestamp": "2025-03-12T07:42:58.762Z",
      "expiresAt": "2025-03-12T07:47:58.760Z"
    }
    ```

#### [GET] /quotes

- **Authorization header required** (`Bearer eyJ...`).
  - If JWT is not sent in the request header, a `401 Unauthorized` response will be returned.
  - If the JWT is expired, a `419 Session expired` response will be returned.
- This endpoint will return a list of all the quotes created no matter if are expired or not
- This one was created for testing purposes.
